/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * RacetrackFrame.java
 *
 * Created on 16.06.2010, 14:46:19
 */

package ch.unizh.ini.jaer.projects.virtualslotcar;

import javax.media.opengl.*;
import java.awt.geom.Point2D;
import com.sun.opengl.util.*;

/**
 * Frame for displaying the OpenGL display of the race
 * @author Michael Pfeiffer
 */
public class RacetrackFrame extends javax.swing.JFrame {

    // OpenGL canvas to draw on
    RaceDisplay trackDisplay;

    // The race track for the race
    SlotcarTrack raceTrack;

    // The car and driver object
    Slotcar myCar;

    // Race mode: running or stopped
    boolean raceMode;

    // Controller thread
    Thread controller;

    // Animator thread
    FPSAnimator fps;


    /** Creates new form RacetrackFrame */
    public RacetrackFrame() {
        raceTrack = null;
        myCar = null;
        initComponents();
        createOpenGLCanvas();
        raceMode = false;
        controller = null;
        fps = null;
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        GoButton = new javax.swing.JButton();
        trackPanel = new javax.swing.JPanel();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("Slotcar Racetrack");
        addComponentListener(new java.awt.event.ComponentAdapter() {
            public void componentResized(java.awt.event.ComponentEvent evt) {
                formComponentResized(evt);
            }
        });

        GoButton.setText("Go!");
        GoButton.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GoButtonMouseClicked(evt);
            }
        });

        javax.swing.GroupLayout trackPanelLayout = new javax.swing.GroupLayout(trackPanel);
        trackPanel.setLayout(trackPanelLayout);
        trackPanelLayout.setHorizontalGroup(
            trackPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 318, Short.MAX_VALUE)
        );
        trackPanelLayout.setVerticalGroup(
            trackPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGap(0, 278, Short.MAX_VALUE)
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(trackPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 13, Short.MAX_VALUE)
                .addComponent(GoButton)
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(trackPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(GoButton))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void formComponentResized(java.awt.event.ComponentEvent evt) {//GEN-FIRST:event_formComponentResized
        // TODO add your handling code here:
        // Resize OpenGL window

        System.out.println("Resizing: " + this.getSize());
        System.out.println("Resizing: " + trackPanel.getSize());
        trackDisplay.setSize(trackPanel.getSize());
    }//GEN-LAST:event_formComponentResized

    private void GoButtonMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GoButtonMouseClicked
        if (raceMode == false) {
            // start the race
            myCar = new Slotcar(raceTrack);
            myCar.setDriveCar(true);

            trackDisplay.setCar(myCar);

            // Start car controller
            // controller = new Thread(myCar);
            // controller.start();

            fps = new FPSAnimator(trackDisplay,60);
            fps.start();
            raceMode = true;
            
            // Change button text
            GoButton.setText("Stop");
        }
        else {
            // Stop controller and animation
            myCar.setDriveCar(false);
            fps.stop();

            GoButton.setText("Go!");

            raceMode = false;
        }
    }//GEN-LAST:event_GoButtonMouseClicked

    private void createOpenGLCanvas() {
        if (trackDisplay != null)
        {
            trackPanel.remove(trackDisplay);
        }
        else {
            // design capabilities of opengl canvas
            GLCapabilities caps = new GLCapabilities();
            caps.setDoubleBuffered(true);
            caps.setHardwareAccelerated(true);
            caps.setAlphaBits(8);
            caps.setRedBits(8);
            caps.setGreenBits(8);
            caps.setBlueBits(8);

            trackDisplay = new RaceDisplay(caps);
            trackPanel.add(trackDisplay);
        }
    }

    /**
     * Sets a new track for the race.
     * @param newTrack The new race track
     */
    public void setTrack(SlotcarTrack newTrack, double stepsize) {
        raceTrack = newTrack;
        trackDisplay.setTrack(raceTrack, stepsize);
    }

    /**
    * @param args the command line arguments
    */
    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                SlotcarTrack rT = new SlotcarTrack();
                rT.addPoint(new Point2D.Double(0, 0));
                rT.addPoint(new Point2D.Double(1, 0));
                rT.addPoint(new Point2D.Double(0.5, -0.5));
                rT.addPoint(new Point2D.Double(-0.5, 0.25));


                RacetrackFrame rf = new RacetrackFrame();
                rf.setVisible(true);

                rf.setTrack(rT, 0.01);


            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton GoButton;
    private javax.swing.JPanel trackPanel;
    // End of variables declaration//GEN-END:variables

}
