C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 1   


C51 COMPILER V7.05, COMPILATION OF MODULE F32X_USB_MAIN
OBJECT MODULE PLACED IN F32x_USB_Main.OBJ
COMPILER INVOKED BY: C:\SiLabs\MCU\IDEfiles\C51\BIN\C51.exe F32x_USB_Main.c DB OE CD

stmt level    source

   1          /*
   2          hex cheat sheet
   3          0000    0x00
   4          0001    0x01
   5          0010    0x02
   6          
   7          0111    0x07
   8          1000    0x08
   9          1001    0x09
  10          1010    0x0a
  11          1011    0x0b
  12          1100    0x0c
  13          1101    0x0d
  14          1110    0x0e
  15          1111    0x0f
  16          
  17          */
  18          // this firmware is for implementing a simple sequencer that gets AE from the computer and sends them out 
             -using AER
  19          
  20          // Tarek Massoud, Tobi Delbruck  jul 2008
  21          
  22          //-----------------------------------------------------------------------------
  23          // Includes
  24          //-----------------------------------------------------------------------------
  25          
  26          #include "c8051f320.h"
  27          #include "F32x_USB_Register.h"
  28          #include "F32x_USB_Main.h"
  29          #include "F32x_USB_Descriptor.h"
  30          
  31          idata BYTE Out_Packet[64];             // Last packet received from host
  32          idata BYTE In_Packet[64];              // Next packet to sent to host
  33          extern BYTE Ep_Status[];
  34          
  35          void    Port_Init(void);                        // Initialize Ports Pins and Enable Crossbar
  36          void    Timer_Init(void);                       // Init timer to use for spike event times
  37          void    Usb0_Init(void);                        //              
  38          
  39          
  40          sbit    NOTREQ  = P0^1;         // !req line, input
  41          sbit    NOTACK  = P0^0;         // !ack line, output
  42          sbit    LedRed  =       P0^3;   //      LED='1' means ON
  43          sbit    LedGreen        =       P0^4;   //      These blink to indicate data transmission
  44          sbit    LedBlue = P0^5;
  45          
  46          //-----------------------------------------------------------------------------
  47          // Main Routine
  48          //-----------------------------------------------------------------------------
  49          void main(void)
  50          {
  51   1              int i;
  52   1              LedRedOn();
  53   1         PCA0MD &= ~0x40;                    // Disable Watchdog timer
  54   1        Sysclk_Init();                      // Initialize oscillator
C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 2   

  55   1              Port_Init();                    // Initialize Ports Pins and Enable Crossbar
  56   1              Timer_Init();                   // Init timer to use for spike event times
  57   1              Usb0_Init();
  58   1              NOTREQ  =       1; // turn off request
  59   1              LedGreenOn();
  60   1              LedBlueOn();
  61   1              
  62   1         while (1)
  63   1         {
  64   2                      if(Ep_Status[2]!=EP_RX){ // if not receiving data
  65   3                              LedRedToggle();
  66   3                              LedGreenToggle();
  67   3                              LedBlueToggle();
  68   3                      }
  69   2                      for(i=0;i<1400;i++){
  70   3                              Delay();
  71   3                      } // about 1 second
  72   2         }
  73   1      }
  74          
  75          
  76          
  77          //-----------------------------------------------------------------------------
  78          // Sysclk_Init
  79          //-----------------------------------------------------------------------------
  80          //
  81          // Return Value : None
  82          // Parameters   : None
  83          //
  84          // Initialize the system clock and USB clock
  85          //
  86          //-----------------------------------------------------------------------------
  87          void Sysclk_Init(void)
  88          {
  89   1      #ifdef _USB_LOW_SPEED_
              
                 OSCICN |= 0x03;                     // Configure internal oscillator for
                                                     // its maximum frequency (12MHz) and enable
                                                     // missing clock detector
              
                 CLKSEL  = SYS_INT_OSC;              // Select System clock
                 CLKSEL |= USB_INT_OSC_DIV_2;        // Select USB clock
              #else
  98   1         OSCICN |= 0x03;                     // Configure internal oscillator for
  99   1                                             // its maximum frequency and enable
 100   1                                             // missing clock detector
 101   1      
 102   1         CLKMUL  = 0x00;                     // Select internal oscillator as
 103   1                                             // input to clock multiplier
 104   1      
 105   1         CLKMUL |= 0x80;                     // Enable clock multiplier
 106   1         Delay();                            // Delay for clock multiplier to begin
 107   1         CLKMUL |= 0xC0;                     // Initialize the clock multiplier
 108   1         Delay();                            // Delay for clock multiplier to begin
 109   1      
 110   1         while(!(CLKMUL & 0x20));            // Wait for multiplier to lock
 111   1         CLKSEL  = SYS_INT_OSC;              // Select system clock at osc/1=12MHz
 112   1         CLKSEL |= USB_4X_CLOCK;             // Select USB clock (48HHz)
 113   1      #endif  /* _USB_LOW_SPEED_ */
 114   1      }
 115          
 116          
C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 3   

 117          //-----------------------------------------------------------------------------
 118          // Usb0_Init
 119          //-----------------------------------------------------------------------------
 120          // - Initialize USB0
 121          // - Enable USB0 interrupts
 122          // - Enable USB0 transceiver
 123          // - Enable USB0 with suspend detection
 124          //-----------------------------------------------------------------------------
 125          void Usb0_Init(void)
 126          {
 127   1         BYTE Count;
 128   1         EA=0; // disable all interrupts
 129   1         // Set initial values of In_Packet and Out_Packet to zero
 130   1         // Initialized here so that WDT doesn't kick in first
 131   1         for (Count = 0; Count < 64; Count++)
 132   1         {
 133   2            Out_Packet[Count] = 0;
 134   2            In_Packet[Count] = 0;
 135   2         }
 136   1      
 137   1      
 138   1         POLL_WRITE_BYTE(POWER,  0x08);      // Force Asynchronous USB Reset
 139   1         POLL_WRITE_BYTE(IN1IE,  0x07);      // Enable Endpoint 0-2 in interrupts
 140   1         POLL_WRITE_BYTE(OUT1IE, 0x07);      // Enable Endpoint 0-2 out interrupts
 141   1         POLL_WRITE_BYTE(CMIE,   0x07);      // Enable Reset,Resume,Suspend interrupts
 142   1      #ifdef _USB_LOW_SPEED_
                 USB0XCN = 0xC0;                     // Enable transceiver; select low speed
                 POLL_WRITE_BYTE(CLKREC, 0xA0);      // Enable clock recovery; single-step mode
                                                     // disabled; low speed mode enabled
              #else
 147   1         USB0XCN = 0xE0;                     // Enable transceiver; select full speed
 148   1         POLL_WRITE_BYTE(CLKREC, 0x80);      // Enable clock recovery, single-step mode
 149   1                                             // disabled
 150   1      #endif // _USB_LOW_SPEED_
 151   1      
 152   1         EIE1 |= 0x02;                       // Enable USB0 Interrupts
 153   1         EA = 1;                             // Global Interrupt enable
 154   1                                             // Enable USB0 by clearing the USB 
 155   1                                             // Inhibit bit
 156   1         POLL_WRITE_BYTE(POWER,  0x01);      // and enable suspend detection
 157   1      }
 158          
 159          
 160          void    Timer_Init(void)
 161          {
 162   1      //----------------------------------------------------------------
 163   1      // Timers Configuration
 164   1      //----------------------------------------------------------------
 165   1      
 166   1          CKCON = 0x04; // t0 clked by sysclk=24MHz 0x00;   // Clock Control Register, timer 0 uses prescaled sy
             -sclk/12. sysclk is 24MHz.
 167   1          TMOD = 0x11;    // Timer Mode Register, timer0 and, timer1 16 bit 00010001
 168   1              TCON = 0x50;    // Timer Control Register , timer0 and 1 running
 169   1          TH0 = 0x00;             // Timer 0 High Byte, reload value. this is FE so that timer clocks FE FF 00, 2 cycle
             -s, 
 170   1          TL0 = 0x00;     // Timer 0 Low Byte
 171   1                      
 172   1      }
 173          
 174          void    Port_Init(void)
 175          {  
 176   1      
C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 4   

 177   1      // P  1 212          O: bit 1 is ACK output, others are inputs (incl REQ on P0.0)
 178   1      // P2: bit 6,7 are LEDs are outputs
 179   1      // don't connect any internal functions to ports
 180   1      // no weak pullups, no internal functions to ports
 181   1      
 182   1      /*
 183   1      Step 1.  Select the input mode (analog or digital) for all Port pins, using the Port Input Mode register (
             -PnMDIN).
 184   1      Step 2.  Select the output mode (open-drain or push-pull) for all Port pins, using the Port Output Mode re
             -gister (PnMDOUT).
 185   1      Step 3.  Select any pins to be skipped by the I/O Crossbar using the Port Skip registers (PnSKIP).
 186   1      Step 4.  Assign Port pins to desired peripherals (XBR0, XBR1).
 187   1      Step 5.  Enable the Crossbar (XBARE = ‘1’).
 188   1      */
 189   1      
 190   1      // Configure the XBRn Registers
 191   1      
 192   1              XBR0 = 0x00;    // 0000 0000 Crossbar Register 1. no peripherals are routed to output.
 193   1              XBR1 = 0x81;    // 1000 0001 Crossbar Register 2. no weak pullups, cex0 routed to port pins.
 194   1      
 195   1          P0MDIN = 0xFF;  // Input configuration for P0. Not using analog input.
 196   1          P1MDIN = 0xFF;  // Input configuration for P1
 197   1          P2MDIN = 0xFF;  // Input configuration for P2
 198   1          P3MDIN = 0xFF;  // Input configuration for P3
 199   1      
 200   1          P0MDOUT = 0x02; // Output configuration for P0, bit 0 is ack input, bit 1 is req output, 0000 0010, 
 201   1                                              // leds are bits 3,4,5 but are open drain, set bit low to pull down and turn on LED
 202   1          P1MDOUT = 0xFF; // Output configuration for P1  // P1 is used for AE lsb 8 bits
 203   1          P2MDOUT = 0xFF; // Output configuration for P2  // P2 is used for AE msb 8 bits
 204   1          P3MDOUT = 0x00; // Output configuration for P3 
 205   1      
 206   1          P0SKIP = 0x01;  //  0000 0001 Port 0 Crossbar Skip Register. Skip first pin so that bit 1 (req) P0.1 b
             -ecomes CEX0 input to PCA capture module
 207   1      
 208   1          P1SKIP = 0x00;  //  Port 1 Crossbar Skip Register
 209   1          P2SKIP = 0x00;  //  Port 2 Crossbar Skip Register
 210   1      
 211   1      
 212   1              XBR1|=0x40;     // 0100 0000 enable xbar
 213   1      
 214   1      }
 215          
 216          void Delay(void)
 217          {
 218   1         int x;
 219   1         for(x = 0;x < 500;x)
 220   1            x++;
 221   1      }
C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 5   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION main (BEGIN)
                                           ; SOURCE LINE # 49
                                           ; SOURCE LINE # 50
                                           ; SOURCE LINE # 52
0000 C283              CLR     LedRed
                                           ; SOURCE LINE # 53
0002 53D9BF            ANL     PCA0MD,#0BFH
                                           ; SOURCE LINE # 54
0005 120000      R     LCALL   Sysclk_Init
                                           ; SOURCE LINE # 55
0008 120000      R     LCALL   Port_Init
                                           ; SOURCE LINE # 56
000B 120000      R     LCALL   Timer_Init
                                           ; SOURCE LINE # 57
000E 120000      R     LCALL   Usb0_Init
                                           ; SOURCE LINE # 58
0011 D281              SETB    NOTREQ
                                           ; SOURCE LINE # 59
0013 C284              CLR     LedGreen
                                           ; SOURCE LINE # 60
0015 C285              CLR     LedBlue
0017         ?C0001:
                                           ; SOURCE LINE # 62
                                           ; SOURCE LINE # 63
                                           ; SOURCE LINE # 64
0017 E500        E     MOV     A,Ep_Status+02H
0019 6402              XRL     A,#02H
001B 6006              JZ      ?C0003
                                           ; SOURCE LINE # 65
001D B283              CPL     LedRed
                                           ; SOURCE LINE # 66
001F B284              CPL     LedGreen
                                           ; SOURCE LINE # 67
0021 B285              CPL     LedBlue
                                           ; SOURCE LINE # 68
0023         ?C0003:
                                           ; SOURCE LINE # 69
0023 E4                CLR     A
0024 F500        R     MOV     i,A
0026 F500        R     MOV     i+01H,A
0028         ?C0004:
0028 C3                CLR     C
0029 E500        R     MOV     A,i+01H
002B 9478              SUBB    A,#078H
002D E500        R     MOV     A,i
002F 6480              XRL     A,#080H
0031 9485              SUBB    A,#085H
0033 50E2              JNC     ?C0001
                                           ; SOURCE LINE # 70
0035 120000      R     LCALL   Delay
                                           ; SOURCE LINE # 71
0038 0500        R     INC     i+01H
003A E500        R     MOV     A,i+01H
003C 70EA              JNZ     ?C0004
003E 0500        R     INC     i
0040         ?C0033:
0040 80E6              SJMP    ?C0004
             ; FUNCTION main (END)

C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 6   

             ; FUNCTION Sysclk_Init (BEGIN)
                                           ; SOURCE LINE # 87
                                           ; SOURCE LINE # 88
                                           ; SOURCE LINE # 98
0000 43B203            ORL     OSCICN,#03H
                                           ; SOURCE LINE # 102
0003 E4                CLR     A
0004 F5B9              MOV     CLKMUL,A
                                           ; SOURCE LINE # 105
0006 43B980            ORL     CLKMUL,#080H
                                           ; SOURCE LINE # 106
0009 120000      R     LCALL   Delay
                                           ; SOURCE LINE # 107
000C 43B9C0            ORL     CLKMUL,#0C0H
                                           ; SOURCE LINE # 108
000F 120000      R     LCALL   Delay
0012         ?C0008:
                                           ; SOURCE LINE # 110
0012 E5B9              MOV     A,CLKMUL
0014 30E5FB            JNB     ACC.5,?C0008
0017         ?C0009:
                                           ; SOURCE LINE # 111
0017 E4                CLR     A
0018 F5A9              MOV     CLKSEL,A
                                           ; SOURCE LINE # 112
                                           ; SOURCE LINE # 114
001A 22                RET     
             ; FUNCTION Sysclk_Init (END)

             ; FUNCTION Usb0_Init (BEGIN)
                                           ; SOURCE LINE # 125
                                           ; SOURCE LINE # 126
                                           ; SOURCE LINE # 128
0000 C2AF              CLR     EA
                                           ; SOURCE LINE # 131
;---- Variable 'Count' assigned to Register 'R7' ----
0002 E4                CLR     A
0003 FF                MOV     R7,A
0004         ?C0011:
                                           ; SOURCE LINE # 132
                                           ; SOURCE LINE # 133
0004 7400        R     MOV     A,#LOW Out_Packet
0006 2F                ADD     A,R7
0007 F8                MOV     R0,A
0008 E4                CLR     A
0009 F6                MOV     @R0,A
                                           ; SOURCE LINE # 134
000A 7400        R     MOV     A,#LOW In_Packet
000C 2F                ADD     A,R7
000D F8                MOV     R0,A
000E E4                CLR     A
000F F6                MOV     @R0,A
                                           ; SOURCE LINE # 135
0010 0F                INC     R7
0011 BF40F0            CJNE    R7,#040H,?C0011
0014         ?C0014:
                                           ; SOURCE LINE # 138
0014 E596              MOV     A,USB0ADR
0016 20E7FB            JB      ACC.7,?C0014
0019         ?C0015:
0019 759601            MOV     USB0ADR,#01H
001C 759708            MOV     USB0DAT,#08H
C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 7   

001F         ?C0016:
                                           ; SOURCE LINE # 139
001F E596              MOV     A,USB0ADR
0021 20E7FB            JB      ACC.7,?C0016
0024         ?C0017:
0024 759607            MOV     USB0ADR,#07H
0027 759707            MOV     USB0DAT,#07H
002A         ?C0018:
                                           ; SOURCE LINE # 140
002A E596              MOV     A,USB0ADR
002C 20E7FB            JB      ACC.7,?C0018
002F         ?C0019:
002F 759609            MOV     USB0ADR,#09H
0032 759707            MOV     USB0DAT,#07H
0035         ?C0020:
                                           ; SOURCE LINE # 141
0035 E596              MOV     A,USB0ADR
0037 20E7FB            JB      ACC.7,?C0020
003A         ?C0021:
003A 75960B            MOV     USB0ADR,#0BH
003D 759707            MOV     USB0DAT,#07H
                                           ; SOURCE LINE # 147
0040 75D7E0            MOV     USB0XCN,#0E0H
0043         ?C0022:
                                           ; SOURCE LINE # 148
0043 E596              MOV     A,USB0ADR
0045 20E7FB            JB      ACC.7,?C0022
0048         ?C0023:
0048 75960F            MOV     USB0ADR,#0FH
004B 759780            MOV     USB0DAT,#080H
                                           ; SOURCE LINE # 152
004E 43E602            ORL     EIE1,#02H
                                           ; SOURCE LINE # 153
0051 D2AF              SETB    EA
0053         ?C0024:
                                           ; SOURCE LINE # 156
0053 E596              MOV     A,USB0ADR
0055 20E7FB            JB      ACC.7,?C0024
0058         ?C0025:
0058 759601            MOV     USB0ADR,#01H
005B 759701            MOV     USB0DAT,#01H
                                           ; SOURCE LINE # 157
005E 22                RET     
             ; FUNCTION Usb0_Init (END)

             ; FUNCTION Timer_Init (BEGIN)
                                           ; SOURCE LINE # 160
                                           ; SOURCE LINE # 161
                                           ; SOURCE LINE # 166
0000 758E04            MOV     CKCON,#04H
                                           ; SOURCE LINE # 167
0003 758911            MOV     TMOD,#011H
                                           ; SOURCE LINE # 168
0006 758850            MOV     TCON,#050H
                                           ; SOURCE LINE # 169
0009 E4                CLR     A
000A F58C              MOV     TH0,A
                                           ; SOURCE LINE # 170
000C F58A              MOV     TL0,A
                                           ; SOURCE LINE # 172
000E 22                RET     
             ; FUNCTION Timer_Init (END)
C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 8   


             ; FUNCTION Port_Init (BEGIN)
                                           ; SOURCE LINE # 174
                                           ; SOURCE LINE # 175
                                           ; SOURCE LINE # 192
0000 E4                CLR     A
0001 F5E1              MOV     XBR0,A
                                           ; SOURCE LINE # 193
0003 75E281            MOV     XBR1,#081H
                                           ; SOURCE LINE # 195
0006 75F1FF            MOV     P0MDIN,#0FFH
                                           ; SOURCE LINE # 196
0009 75F2FF            MOV     P1MDIN,#0FFH
                                           ; SOURCE LINE # 197
000C 75F3FF            MOV     P2MDIN,#0FFH
                                           ; SOURCE LINE # 198
000F 75F4FF            MOV     P3MDIN,#0FFH
                                           ; SOURCE LINE # 200
0012 75A402            MOV     P0MDOUT,#02H
                                           ; SOURCE LINE # 202
0015 75A5FF            MOV     P1MDOUT,#0FFH
                                           ; SOURCE LINE # 203
0018 75A6FF            MOV     P2MDOUT,#0FFH
                                           ; SOURCE LINE # 204
001B F5A7              MOV     P3MDOUT,A
                                           ; SOURCE LINE # 206
001D 75D401            MOV     P0SKIP,#01H
                                           ; SOURCE LINE # 208
0020 F5D5              MOV     P1SKIP,A
                                           ; SOURCE LINE # 209
0022 F5D6              MOV     P2SKIP,A
                                           ; SOURCE LINE # 212
0024 43E240            ORL     XBR1,#040H
                                           ; SOURCE LINE # 214
0027 22                RET     
             ; FUNCTION Port_Init (END)

             ; FUNCTION Delay (BEGIN)
                                           ; SOURCE LINE # 216
                                           ; SOURCE LINE # 217
                                           ; SOURCE LINE # 219
;---- Variable 'x' assigned to Register 'R6/R7' ----
0000 E4                CLR     A
0001 FF                MOV     R7,A
0002 FE                MOV     R6,A
0003         ?C0029:
                                           ; SOURCE LINE # 220
0003 0F                INC     R7
0004 BF0001            CJNE    R7,#00H,?C0034
0007 0E                INC     R6
0008         ?C0034:
0008 BE01F8            CJNE    R6,#01H,?C0029
000B BFF4F5            CJNE    R7,#0F4H,?C0029
                                           ; SOURCE LINE # 221
000E         ?C0032:
000E 22                RET     
             ; FUNCTION Delay (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    258    ----
C51 COMPILER V7.05   F32X_USB_MAIN                                                         07/21/2008 19:35:11 PAGE 9   

   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =    128    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
